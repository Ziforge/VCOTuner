name: Build

on:
  push:
    branches: [ master, main ]
  pull_request:
    branches: [ master, main ]
  workflow_dispatch:

jobs:
  build-macos:
    runs-on: macos-latest
    steps:
    - uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Configure CMake
      run: cmake -B build -DCMAKE_BUILD_TYPE=Release

    - name: Build
      run: cmake --build build --config Release

    - name: List build artifacts
      run: find build -name "VCOTuner*" -type f -o -name "VCOTuner*.app" -type d 2>/dev/null || true

    - name: Ad-hoc code sign with entitlements
      run: |
        APP_PATH=$(find build -name "VCOTuner.app" -type d | head -1)
        if [ -n "$APP_PATH" ]; then
          echo "Signing app at: $APP_PATH with entitlements"
          codesign --force --deep --sign - --entitlements macOS/entitlements.plist "$APP_PATH"
          echo "Verifying signature..."
          codesign -dvv "$APP_PATH" || true
        fi

    - name: Create distribution ZIP
      run: |
        APP_PATH=$(find build -name "VCOTuner.app" -type d | head -1)
        if [ -n "$APP_PATH" ]; then
          cd $(dirname "$APP_PATH")
          cat > README.txt << 'READMEEOF'
        VCOTuner - VCO Calibration Tool

        INSTALLATION
        1. Unzip this archive
        2. Drag VCOTuner.app to your Applications folder

        FIRST RUN - macOS Sequoia 15.x / Sonoma 14.x
        Since this app is not notarized by Apple, macOS will block it.

        METHOD 1 (Recommended)
        1. Open Terminal (Applications > Utilities > Terminal)
        2. Run this command: xattr -cr /Applications/VCOTuner.app
        3. Double-click VCOTuner.app to run

        METHOD 2 (Right-click)
        1. Right-click (or Control-click) on VCOTuner.app
        2. Select Open from the context menu
        3. Click Open in the security dialog
        4. If blocked, go to System Settings then Privacy and Security
        5. Scroll down and click Open Anyway

        MICROPHONE ACCESS
        The app needs microphone access to detect pitch.
        Grant permission when prompted by macOS.

        More info at https://github.com/Ziforge/VCOTuner
        READMEEOF
          zip -r VCOTuner-macOS.zip VCOTuner.app README.txt
          mv VCOTuner-macOS.zip ../..
        fi

    - name: Upload macOS Build
      uses: actions/upload-artifact@v4
      with:
        name: VCOTuner-macOS
        path: |
          build/VCOTuner-macOS.zip
        if-no-files-found: warn
        retention-days: 90

  build-windows:
    runs-on: windows-latest
    steps:
    - uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Configure CMake
      run: cmake -B build -DCMAKE_BUILD_TYPE=Release

    - name: Build
      run: cmake --build build --config Release

    - name: List build artifacts
      run: Get-ChildItem -Recurse -Path build -Filter "VCOTuner*" | Select-Object FullName
      shell: pwsh

    - name: Create distribution ZIP
      run: |
        $exe = Get-ChildItem -Recurse -Path build -Filter "VCOTuner.exe" | Select-Object -First 1
        if ($exe) {
          $dir = Split-Path $exe.FullName
          $readme = @"
        VCOTuner - VCO Calibration Tool

        INSTALLATION
        1. Extract VCOTuner.exe to a folder of your choice
        2. Double-click VCOTuner.exe to run

        Windows may show a SmartScreen warning since the app is not signed.
        Click More info then Run anyway to proceed.

        More info at https://github.com/Ziforge/VCOTuner
        "@
          $readme | Out-File -FilePath "$dir\README.txt" -Encoding UTF8
          Compress-Archive -Path "$dir\VCOTuner.exe","$dir\README.txt" -DestinationPath "build\VCOTuner-Windows.zip"
        }
      shell: pwsh

    - name: Upload Windows Build
      uses: actions/upload-artifact@v4
      with:
        name: VCOTuner-Windows
        path: build/VCOTuner-Windows.zip
        if-no-files-found: warn
        retention-days: 90

  build-linux:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Install Dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y libasound2-dev libcurl4-openssl-dev libfreetype6-dev libx11-dev libxcomposite-dev libxcursor-dev libxinerama-dev libxrandr-dev libxrender-dev libwebkit2gtk-4.1-dev

    - name: Configure CMake
      run: cmake -B build -DCMAKE_BUILD_TYPE=Release

    - name: Build
      run: cmake --build build --config Release

    - name: List build artifacts
      run: find build -name "VCOTuner*" -type f 2>/dev/null || true

    - name: Create distribution tarball
      run: |
        EXE_PATH=$(find build -name "VCOTuner" -type f -executable | head -1)
        if [ -n "$EXE_PATH" ]; then
          mkdir -p dist
          cp "$EXE_PATH" dist/
          cat > dist/README.txt << 'READMEEOF'
        VCOTuner - VCO Calibration Tool

        INSTALLATION
        1. Extract the archive
        2. Make the binary executable with chmod +x VCOTuner
        3. Run with ./VCOTuner

        DEPENDENCIES
        You may need to install libasound2, libfreetype6, libx11-6

        More info at https://github.com/Ziforge/VCOTuner
        READMEEOF
          tar -czvf build/VCOTuner-Linux.tar.gz -C dist .
        fi

    - name: Upload Linux Build
      uses: actions/upload-artifact@v4
      with:
        name: VCOTuner-Linux
        path: build/VCOTuner-Linux.tar.gz
        if-no-files-found: warn
        retention-days: 90
